/***************************************************
*
* cismet GmbH, Saarbruecken, Germany
*
*              ... and it just works.
*
****************************************************/
package Sirius.navigator.ui.status;

import Sirius.navigator.DefaultNavigatorExceptionHandler;
import Sirius.navigator.DefaultNavigatorExceptionHandlerListener;

import org.jdesktop.swingx.JXErrorPane;
import org.jdesktop.swingx.error.ErrorInfo;

import org.openide.util.NbBundle;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

import java.util.logging.Level;

import javax.swing.Timer;

import de.cismet.tools.gui.StaticSwingTools;
import javax.swing.JFrame;

/**
 * DOCUMENT ME!
 *
 * @author   Gilles Baatz
 * @version  $Revision$, $Date$
 */
public class ExceptionNotificationStatusPanel extends javax.swing.JPanel
        implements DefaultNavigatorExceptionHandlerListener {

    //~ Instance fields --------------------------------------------------------

    private Throwable uncaughtException;
    private final Timer flashTimer;
    private final Timer steadyTimer;

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private org.jdesktop.swingx.JXHyperlink hlErrorIcon;
    // End of variables declaration//GEN-END:variables

    //~ Constructors -----------------------------------------------------------

    /**
     * Creates new form ExceptionNotificationStatusPanel.
     */
    public ExceptionNotificationStatusPanel() {
        initComponents();
        DefaultNavigatorExceptionHandler.getInstance().addListener(this);

        flashTimer = new Timer(500, new FlashHandler());
        flashTimer.setCoalesce(true);
        flashTimer.setRepeats(true);
        flashTimer.setInitialDelay(0);

        steadyTimer = new Timer(30 * 1000, new SteadyHandler());
        steadyTimer.setCoalesce(true);
        steadyTimer.setRepeats(false);
    }

    //~ Methods ----------------------------------------------------------------

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The
     * content of this method is always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        hlErrorIcon = new org.jdesktop.swingx.JXHyperlink();

        setLayout(new java.awt.GridLayout(1, 0));

        hlErrorIcon.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Sirius/navigator/resource/img/exclamation-red-frame.png"))); // NOI18N
        org.openide.awt.Mnemonics.setLocalizedText(hlErrorIcon, org.openide.util.NbBundle.getMessage(ExceptionNotificationStatusPanel.class, "ExceptionNotificationStatusPanel.hlErrorIcon.text")); // NOI18N
        hlErrorIcon.setEnabled(false);
        hlErrorIcon.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                hlErrorIconActionPerformed(evt);
            }
        });
        add(hlErrorIcon);
    }// </editor-fold>//GEN-END:initComponents

    /**
     * DOCUMENT ME!
     *
     * @param  evt  DOCUMENT ME!
     */
    private void hlErrorIconActionPerformed(final java.awt.event.ActionEvent evt) {//GEN-FIRST:event_hlErrorIconActionPerformed
        final ErrorInfo ei = new ErrorInfo(
                NbBundle.getMessage(
                    ExceptionNotificationStatusPanel.class,
                    "ExceptionNotificationStatusPanel.hlErrorIconActionPerformed().error.title"),
                uncaughtException.getMessage(),
                null,
                null,
                uncaughtException,
                Level.ALL,
                null);
        JXErrorPane.showDialog(StaticSwingTools.getParentFrameIfNotNull(this), ei);
    }//GEN-LAST:event_hlErrorIconActionPerformed

    @Override
    public void uncaughtException(final Thread thread, final Throwable error) {
        anErrorOccurred(thread, error);
    }

    /**
     * DOCUMENT ME!
     *
     * @param  thread  DOCUMENT ME!
     * @param  error   DOCUMENT ME!
     */
    public void anErrorOccurred(final Thread thread, final Throwable error) {
        uncaughtException = error;
        flashTimer.restart();
    }
    
    public static void main(String[] args) {
        JFrame frame = new JFrame();
        ExceptionNotificationStatusPanel panel = new ExceptionNotificationStatusPanel();
        frame.add(panel);
        frame.setVisible(true);
        panel.anErrorOccurred(null, new NullPointerException());
        
    }

    //~ Inner Classes ----------------------------------------------------------

    /**
     * DOCUMENT ME!
     *
     * @version  $Revision$, $Date$
     */
    public class FlashHandler implements ActionListener {

        //~ Instance fields ----------------------------------------------------

        private int counter;

        //~ Methods ------------------------------------------------------------

        @Override
        public void actionPerformed(final ActionEvent ae) {
            hlErrorIcon.setEnabled((counter % 2) == 0);
            counter++;
            if (counter > 10) {
                counter = 0;
                hlErrorIcon.setEnabled(true);
                ((Timer)ae.getSource()).stop();
                steadyTimer.restart();
            }
        }
    }

    /**
     * DOCUMENT ME!
     *
     * @version  $Revision$, $Date$
     */
    public class SteadyHandler implements ActionListener {

        //~ Methods ------------------------------------------------------------

        @Override
        public void actionPerformed(final ActionEvent ae) {
            hlErrorIcon.setEnabled(false);
        }
    }
}
